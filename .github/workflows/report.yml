name: Build Naturalia Report
on:
  schedule:
    - cron: '0 6 * * 1'   # Mondays 06:00 UTC
  workflow_dispatch:
    inputs:
      lookback_days:
        description: "How many days back to ingest"
        required: false
        default: "365"
      send_email:
        description: "Send email summary?"
        required: false
        default: "true"
  push:
    paths:
      - 'data/**'
      - 'src/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Recreate Gmail creds (for ingestion)
        run: |
          echo "$GMAIL_CREDENTIALS_B64" | base64 -d > credentials.json
          echo "$GMAIL_TOKEN_B64"       | base64 -d > token.json
        env:
          GMAIL_CREDENTIALS_B64: ${{ secrets.GMAIL_CREDENTIALS_B64 }}
          GMAIL_TOKEN_B64:       ${{ secrets.GMAIL_TOKEN_B64 }}

      - name: System deps (OCR fallback)
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils tesseract-ocr

      - name: Python deps
        run: pip install -r requirements.txt

      - name: Ingest Naturalia PDFs via Gmail API
        env:
          LOOKBACK_DAYS: ${{ github.event.inputs.lookback_days || '365' }}
        run: python src/gmail_pull.py

      - name: Build report artifacts
        run: python src/build_report.py

      - name: Commit updated data & charts
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add reports/*.png reports/summary.md data/*.csv data/hashes.txt || true
          git commit -m "Auto: update Naturalia report" || true
          git push

      - name: Email weekly overview
        if: ${{ (github.event.inputs.send_email || 'true') == 'true' }}
        env:
          SMTP_SERVER:   ${{ secrets.SMTP_SERVER }}
          SMTP_PORT:     ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_EMAIL:    ${{ secrets.FROM_EMAIL }}
          TO_EMAIL:      ${{ secrets.TO_EMAIL }}
        run: |
          python - <<'PY'
          import os, smtplib, email.message, pathlib, pandas as pd
          body_path = pathlib.Path("reports/summary.md")
          if not body_path.exists():
              print("No summary.md; skipping email."); raise SystemExit(0)
          body = body_path.read_text(encoding="utf-8")
          msg = email.message.EmailMessage()
          msg["Subject"] = "Naturalia â€” Weekly Overview"
          msg["From"] = os.environ["FROM_EMAIL"]
          msg["To"]   = os.environ["TO_EMAIL"]
          msg.set_content(body)
          for fname in ("weekly.png","price_changes.png"):
              p = pathlib.Path("reports")/fname
              if p.exists():
                  with p.open("rb") as f:
                      msg.add_attachment(f.read(), maintype="image", subtype="png", filename=fname)
          s = smtplib.SMTP(os.environ["SMTP_SERVER"], int(os.environ["SMTP_PORT"]))
          s.starttls(); s.login(os.environ["SMTP_USERNAME"], os.environ["SMTP_PASSWORD"])
          s.send_message(msg); s.quit()
          PY
