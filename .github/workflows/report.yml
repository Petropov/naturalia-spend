name: Build Naturalia Report

on:
  workflow_dispatch:
    inputs:
      lookback_days:
        description: Days to look back for Gmail attachments
        required: false
        default: 'ALL'
      trigger_reason:
        description: Why this workflow was triggered (manual/schedule/new_receipt)
        required: false
        default: manual
  schedule:
    # Cron is in UTC. Change this to adjust local run time.
    - cron: '0 15 * * 6'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Python syntax check
        run: find scripts src -name "*.py" -print0 | xargs -0 -I{} python -m py_compile {}


      - name: Install OCR tools
        run: sudo apt-get update && sudo apt-get install -y tesseract-ocr tesseract-ocr-fra poppler-utils

      - name: Python deps
        run: pip install -r requirements.txt

      - name: Dep sanity
        run: |
          python - <<'PY'
          import sys
          print("python", sys.version)
          import pdfminer.high_level, pytesseract, pandas, PIL
          print("dep-check: ok")
          PY

      - name: Recreate Gmail creds (for ingestion)
        env:
          GMAIL_CREDENTIALS_B64: ${{ secrets.GMAIL_CREDENTIALS_B64 }}
          GMAIL_TOKEN_B64:       ${{ secrets.GMAIL_TOKEN_B64 }}
        run: |
          echo "$GMAIL_CREDENTIALS_B64" | base64 -d > credentials.json
          echo "$GMAIL_TOKEN_B64"       | base64 -d > token.json

      - name: Ingest Naturalia PDFs via Gmail API
        env:
          LOOKBACK_DAYS: ${{ github.event.inputs.lookback_days || 'ALL' }}
          TRIGGER_REASON: ${{ github.event.inputs.trigger_reason || github.event_name }}
          GMAIL_SEARCH_Q: >-
            from:naturalia has:attachment filename:pdf
        run: python -m src.gmail_pull

      - name: OCR conservative items
        working-directory: ${{ github.workspace }}
        run: |
          SCRIPT="$GITHUB_WORKSPACE/scripts/ocr_items_from_pdfs_conservative"
          if [ ! -f "$SCRIPT" ]; then
            echo "Expected OCR script at $SCRIPT but it was not found." >&2
            exit 1
          fi
          PYTHONPATH=$GITHUB_WORKSPACE python "$SCRIPT"

      - name: Debug workspace on failure
        if: failure()
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          pwd
          ls -la
          ls -la scripts

      - name: Build sanity report
        run: python scripts/sanity_reconciliation.py


      - name: Build HTML dashboard
        run: PYTHONPATH=$GITHUB_WORKSPACE python -m scripts.build_dashboard


      - name: Package outputs
        run: |
          mkdir -p out
          [ -f data/receipts.csv ] && cp -v data/receipts.csv out/ || true
          [ -f data/items.csv ]    && cp -v data/items.csv out/    || true
          [ -f artifacts/dashboard.html ] && cp -v artifacts/dashboard.html out/ || true
          [ -f artifacts/categories_learned.csv ] && cp -v artifacts/categories_learned.csv out/ || true
          [ -f artifacts/categories_breakdown.csv ] && cp -v artifacts/categories_breakdown.csv out/ || true
          [ -f artifacts/categories_meta.json ] && cp -v artifacts/categories_meta.json out/ || true
          [ -f artifacts/sanity_report.csv ] && cp -v artifacts/sanity_report.csv out/ || true
          [ -f artifacts/sanity_summary.txt ] && cp -v artifacts/sanity_summary.txt out/ || true
          echo "${{ github.run_id }}" > out/_run_id.txt

      - name: Set TODAY date
        run: echo "TODAY=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: naturalia-${{ github.run_id }}-${{ env.TODAY }}-${{ github.event.inputs.lookback_days || 'ALL' }}d
          path: out/**
          retention-days: 30

      - name: Summary (dashboard)
        run: |
          echo "## Naturalia Ingestion â€“ Run $GITHUB_RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Lookback**: ${{ github.event.inputs.lookback_days || 'ALL' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Query**: \`from:naturalia has:attachment filename:pdf\`" >> $GITHUB_STEP_SUMMARY
          if [ -f data/receipts.csv ]; then
            RCPTS=$(($(wc -l < data/receipts.csv)-1)); RCPTS=${RCPTS#-}
            echo "- **Receipts rows**: ${RCPTS:-0}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f data/items.csv ]; then
            ITEMS=$(($(wc -l < data/items.csv)-1)); ITEMS=${ITEMS#-}
            echo "- **Line items**: ${ITEMS:-0}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifact: \`naturalia-${GITHUB_RUN_ID}-${{ env.TODAY }}-${{ github.event.inputs.lookback_days || 'ALL' }}d\`" >> $GITHUB_STEP_SUMMARY
